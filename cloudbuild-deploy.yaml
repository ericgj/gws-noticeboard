
steps:
  - name: 'gcr.io/cloud-builders/gcloud'   
    entrypoint: '/bin/sh'
    args:
    - -c
    - 'bin/kms decrypt ${_ENV} --project ${PROJECT_ID}'

  - name: 'gcr.io/cloud-builders/docker'
    entrypoint: '/bin/sh'
    args: 
    - -c
    - 'bin/test functions write ${_ENV}'

  - name: 'gcr.io/cloud-builders/docker'
    entrypoint: '/bin/sh'
    args: 
    - -c
    - 'bin/test functions fetch ${_ENV}'

  # Fetch next app state (blue or green) based on GAE traffic split
  - name: 'gcr.io/cloud-builders/gcloud'
    entrypoint: '/bin/sh'
    args:
    - -c
    - 'bin/fetch-app-state ${_ENV} --next --service default --project ${PROJECT_ID} > app-state.txt'

  # Deploy write function given next blue/green app state
  - name: 'gcr.io/cloud-builders/gcloud'
    entrypoint: '/bin/sh'
    args: 
    - -c
    - 'bin/deploy functions write ${_ENV} --app-state "$(cat app-state.txt)" --project ${PROJECT_ID}'

  # Deploy fetch function given next blue/green app state
  # publishing to write (pubsub topic)
  - name: 'gcr.io/cloud-builders/gcloud'
    entrypoint: '/bin/sh'
    args: 
    - -c
    - 'bin/deploy functions fetch ${_ENV} --app-state "$(cat app-state.txt)" --publish-topic write --project ${PROJECT_ID}'

  # Deploy default GAE service given next blue/green app state
  - name: 'gcr.io/cloud-builders/gcloud'
    entrypoint: '/bin/sh'
    args: 
    - -c
    - 'bin/deploy services default ${_ENV} --app-state "$(cat app-state.txt)" --project ${PROJECT_ID}'

substitutions:
  _ENV: staging

