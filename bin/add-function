#!/usr/bin/env sh
set -e

FUNC=${1}

if [ -z "${FUNC}" ]; then
  echo "Usage: ${0} FUNCTION_NAME" >&2
  exit 1
fi

PROJ=$(cat secrets/project)

if [ -z "${PROJ}" ]; then
    echo "Project not found. Check secrets/project file." >&2
    exit 1
fi

echo "Creating function template..." >&2
cd functions && \
    cookiecutter git+ssh://git@bitbucket.org/ericgj/ert-gcf-function-cookiecutter.git && \
    cd ..

echo "Creating service account for function..." >&2
gcloud iam service-accounts create "${PROJ}-${FUNC}" \
    --project "${PROJ}"

echo "Saving key for service account..." >&2
mkdir -p "secrets/test/service-accounts"
gcloud iam service-accounts keys create "secrets/test/service-accounts/${FUNC}.json" \
    --iam-account "${PROJ}-${FUNC}@${PROJ}.iam.gserviceaccount.com" \
    --project "${PROJ}"
    
echo "Done." >&2

