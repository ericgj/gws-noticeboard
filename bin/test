#!/usr/bin/env sh
set -e

SUBDIR=${1}
NAME=${2}
ENV=${3-test}

if [ -z "${SUBDIR}" ] || [ -z "${NAME}" ]; then
    echo "Error: missing parameter(s)." >&2
    echo "    Usage: ${0} TYPE NAME [ENV]" >&2
    echo "    Example: ${0} functions myfunction staging"  >&2
    exit 1
fi

PROJ=$(cat secrets/project)

if [ -z "${PROJ}" ]; then
    echo "Project not found. Check secrets/project file." >&2
    exit 1
fi


mkdir -p "${SUBDIR}/${NAME}/secrets/${ENV}"
cp secrets/${ENV}/* "${SUBDIR}/${NAME}/secrets/${ENV}/"

cd "${SUBDIR}/${NAME}"

echo "Building test container..." >&2
docker build -f "images/test" -t "${PROJ}/test/${SUBDIR}/${NAME}" .

echo "Running tests..." >&2
docker run "${PROJ}/test/${SUBDIR}/${NAME}"

echo "Done." >&2
