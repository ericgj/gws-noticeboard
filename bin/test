#!/usr/bin/env sh
set -e

SUBDOM=${1}
SERVICE=${2}
BUILDDIR=${3-build}

if [ -z "${SUBDOM}" ] || [ -z "${SERVICE}" ]; then
    echo "Error: missing parameter(s)." >&2
    echo "    Usage: ${0} SUBDOMAIN SERVICE [BUILDDIR]" >&2
    echo "    Example: ${0} MySubdomain MyService"  >&2
    exit 1
fi

PROJ=$(cat secrets/project)
if [ -z "${PROJ}" ]; then
    echo "Project not found. Check secrets/project file." >&2
    exit 1
fi

DOCKERFILE="images/test"
if [ ! -f "${DOCKERFILE}" ]; then
    echo "Error: missing Dockerfile ${DOCKERFILE}" >&2
    exit 1
fi

# bin/build "${SUBDOM}" "${SERVICE}" "${BUILDDIR}"

DOCKERTAG=$( echo "${PROJ}/${SUBDOM}/${SERVICE}/test" | tr "[:upper:]" "[:lower:]" )

echo "Building test container..." >&2
docker build -f "${DOCKERFILE}" \
    -t "${DOCKERTAG}" \
    --build-arg "service=${SERVICE}" \
    "${BUILDDIR}"

echo "Running tests..." >&2
docker run "${DOCKERTAG}"

echo "Done." >&2
