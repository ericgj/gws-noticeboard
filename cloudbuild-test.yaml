
steps:
  
  # Decrypt secrets
  - name: 'gcr.io/cloud-builders/gcloud'   
    entrypoint: '/bin/sh'
    args:
    - -c
    - 'bin/kms decrypt ${_ENV}'

  # Unit test write function
  - name: 'python:3.7-alpine'
    entrypoint: '/bin/sh'
    args: 
    - -c
    - 'bin/test-function write ${_ENV}'

  # Unit test fetch function
  - name: 'python:3.7-alpine'
    entrypoint: '/bin/sh'
    args: 
    - -c
    - 'bin/test-function fetch ${_ENV}'

  # Deploy write function
  - name: 'gcr.io/cloud-builders/gcloud'
    entrypoint: '/bin/sh'
    args: 
    - -c
    - 'bin/deploy-function write ${_ENV}'

  # Deploy fetch function publishing to write (pubsub topic)
  - name: 'gcr.io/cloud-builders/gcloud'
    entrypoint: '/bin/sh'
    args: 
    - -c
    - 'bin/deploy-function fetch ${_ENV} "" write'

  # Deploy default GAE service 
  - name: 'gcr.io/cloud-builders/gcloud'
    entrypoint: '/bin/sh'
    args: 
    - -c
    - 'bin/deploy-service default ${_ENV} 
  
  # Run system tests
  - name: 'python:3.7-alpine'
    entrypoint: '/bin/sh'
    args: 
    - -c
    - 'bin/test ${_ENV}'

substitutions:
  _ENV: test

